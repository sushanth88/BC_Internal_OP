<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Internal Accounting</title>
    {# CSRF token for JS fetches; Flask-WTF provides csrf_token() when CSRFProtect is enabled #}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body>
    <header>
      <h1>Internal Accounting</h1>
      {% include '_nav.html' %}
      {% if current_user.is_authenticated and not current_user.is_admin %}
        {# show quick summary for regular users whether today's transaction exists #}
        <div class="header-summary">
          {% set today_tx = namespace(found=False, id=None) %}
          {% for tx in (transactions or []) %}
            {% if tx.date == (today or None) %}
              {% set today_tx.found = True %}
              {% set today_tx.id = tx.id %}
            {% endif %}
          {% endfor %}
          {% if today_tx.found %}
            Today's transaction exists — <a href="{{ url_for('edit_transaction', tx_id=today_tx.id) }}">Edit</a>
          {% else %}
            No transaction for today — <a href="{{ url_for('new_transaction') }}">Add now</a>
          {% endif %}
        </div>
      {% endif %}
      <hr />
    </header>
    <main>
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <ul>
          {% for category, msg in messages %}
            <li><strong>[{{ category }}]</strong> {{ msg }}</li>
          {% endfor %}
          </ul>
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>
    <script>
      document.addEventListener('click', function(ev) {
        var el = ev.target;
        if (el.classList && el.classList.contains('delete-link')) {
          ev.preventDefault();
          if (!confirm('Delete transaction ' + el.dataset.id + '?')) return;
          // read optional CSRF token from meta tag if present
          var headers = {'Content-Type': 'application/x-www-form-urlencoded'};
          var meta = document.querySelector('meta[name="csrf-token"]');
          if (meta && meta.content) {
            headers['X-CSRFToken'] = meta.content;
          }
          fetch('/transactions/' + el.dataset.id + '/delete', { method: 'POST', headers: headers, credentials: 'same-origin' })
            .then(function(r){
              if (r.ok) {
                location.reload();
              } else if (r.status === 403) {
                alert('Forbidden: you do not have permission to delete this transaction.');
              } else if (r.status === 401) {
                // probably logged out
                alert('You appear to be logged out. Please refresh and log in again.');
                location.reload();
              } else {
                r.text().then(function(t){ console.error(t); alert('Delete failed'); });
              }
            })
            .catch(function(){ alert('Delete failed'); });
        }
      });
    </script>
  </body>
</html>
