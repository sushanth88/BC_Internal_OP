<!doctype html>
<html>
  <head>
  <meta charset="utf-8">
  <title>Biryani City Portal</title>
    {# CSRF token for JS fetches; Flask-WTF provides csrf_token() when CSRFProtect is enabled #}
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <meta name="color-scheme" content="light dark">
    <script>
      // Apply stored theme ASAP and preload Water.css variants; enable only the active one
      // Scroll hint for wide tables: toggle .is-scrollable when horizontally overflowed
      (function(){
        function updateHints(){
          document.querySelectorAll('.tx-table-wrap').forEach(function(wrap){
            if (!wrap) return;
            var el = wrap.querySelector('table');
            if (!el) return;
            var isOverflow = el.scrollWidth > wrap.clientWidth + 2; // tolerate tiny rounding
            var atStart = wrap.scrollLeft <= 0;
            var atEnd = (wrap.scrollLeft + wrap.clientWidth) >= (el.scrollWidth - 2);
            wrap.classList.toggle('is-scrollable', isOverflow && !atEnd);
            wrap.classList.toggle('scrolled', isOverflow && !atStart);
          });
        }
        // Bind events
        window.addEventListener('resize', updateHints);
        document.addEventListener('themechange', updateHints);
        // Update when new content may be injected
        document.addEventListener('DOMContentLoaded', function(){
          updateHints();
          document.querySelectorAll('.tx-table-wrap').forEach(function(wrap){
            wrap.addEventListener('scroll', function(){
              var el = wrap.querySelector('table');
              if (!el) return;
              var atEnd = (wrap.scrollLeft + wrap.clientWidth) >= (el.scrollWidth - 1);
              var atStart = wrap.scrollLeft <= 0;
              wrap.classList.toggle('is-scrollable', !atEnd);
              wrap.classList.toggle('scrolled', !atStart);
            });
          });
        });
      })();
      (function(){
        try {
          var mode = localStorage.getItem('theme-mode');
          if (mode && mode !== 'auto') {
            document.documentElement.setAttribute('data-theme', mode);
          }
          var base = 'https://cdn.jsdelivr.net/npm/water.css@2/out/';
          function ensureLink(id, href){
            var el = document.getElementById(id);
            if (!el){
              el = document.createElement('link');
              el.id = id; el.rel = 'stylesheet'; el.href = href; el.disabled = true;
              document.write(el.outerHTML);
            }
          }
          ensureLink('watercss-auto', base + 'water.css');
          ensureLink('watercss-light', base + 'light.css');
          ensureLink('watercss-dark', base + 'dark.css');
          function setEnabled(m){
            var a = document.getElementById('watercss-auto');
            var l = document.getElementById('watercss-light');
            var d = document.getElementById('watercss-dark');
            if (!a || !l || !d) return;
            a.disabled = !(m === null || m === 'auto');
            l.disabled = !(m === 'light');
            d.disabled = !(m === 'dark');
          }
          setEnabled(mode || 'auto');
        } catch(e) {}
      })();
    </script>
    <!-- Fallback if JS is blocked -->
    <noscript>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
    </noscript>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  </head>
  <body data-page="{{ request.endpoint }}">
    <script>
      (function(){
        try {
          var st = localStorage.getItem('ui-sidebar-state');
          if (st === 'open') {
            document.body.classList.add('sidebar-open');
          } else {
            document.body.classList.add('sidebar-collapsed');
          }
        } catch(_){ document.body.classList.add('sidebar-collapsed'); }
      })();
    </script>
    {% set is_login = (request.endpoint == 'login') %}
    {% if not is_login %}
      {% include '_nav.html' %}
      <script>
        (function(){
          var sidebar = document.getElementById('sidebar');
          if (!sidebar) return;
          function expand(){ document.body.classList.add('sidebar-hover'); }
          function collapse(){ document.body.classList.remove('sidebar-hover'); }
          sidebar.addEventListener('mouseenter', expand);
          sidebar.addEventListener('mouseleave', collapse);
          sidebar.addEventListener('focusin', expand);
          sidebar.addEventListener('focusout', function(){ if (!sidebar.contains(document.activeElement)) collapse(); });
          try { if (localStorage.getItem('ui-sidebar-state') === 'open') expand(); } catch(_){}
          document.addEventListener('keydown', function(ev){ if (ev.key === 'Escape') collapse(); });
        })();
      </script>
      <script>
        (function(){
          var nav = document.querySelector('.nav-vertical');
          if (!nav) return;
          nav.addEventListener('mouseover', function(ev){
            var parentLink = ev.target.closest('.parent');
            if (parentLink && parentLink.parentElement && parentLink.parentElement.classList.contains('has-submenu')) {
              parentLink.setAttribute('aria-expanded','true');
              parentLink.parentElement.setAttribute('aria-expanded','true');
            }
          });
          nav.addEventListener('mouseout', function(ev){
            var parentLink = ev.target.closest('.parent');
            if (parentLink && parentLink.parentElement && parentLink.parentElement.classList.contains('has-submenu')) {
              if (!parentLink.matches(':focus')) {
                parentLink.setAttribute('aria-expanded','false');
                parentLink.parentElement.setAttribute('aria-expanded','false');
              }
            }
          });
          nav.addEventListener('keydown', function(ev){
            var tgt = ev.target;
            if (tgt && tgt.classList && tgt.classList.contains('parent') && (ev.key === ' ' || ev.key === 'Enter')) {
              ev.preventDefault();
              var expanded = tgt.getAttribute('aria-expanded') === 'true';
              var next = !expanded;
              tgt.setAttribute('aria-expanded', next ? 'true' : 'false');
              if (tgt.parentElement) tgt.parentElement.setAttribute('aria-expanded', next ? 'true' : 'false');
            }
            if (ev.key === 'Escape') {
              var openParents = nav.querySelectorAll('.has-submenu[aria-expanded="true"]');
              openParents.forEach(function(p){ p.setAttribute('aria-expanded','false'); var link = p.querySelector('.parent'); if (link) link.setAttribute('aria-expanded','false'); });
            }
          });
          nav.addEventListener('focusin', function(ev){
            var parentLink = ev.target.closest('.parent');
            if (parentLink && parentLink.parentElement && parentLink.parentElement.classList.contains('has-submenu')) {
              parentLink.setAttribute('aria-expanded','true');
              parentLink.parentElement.setAttribute('aria-expanded','true');
            }
          });
            nav.addEventListener('focusout', function(ev){
              var parentLink = ev.target.closest('.parent');
              if (parentLink && parentLink.parentElement && parentLink.parentElement.classList.contains('has-submenu')) {
                setTimeout(function(){
                  var stillWithin = parentLink.parentElement.contains(document.activeElement);
                  if (!stillWithin) {
                    parentLink.setAttribute('aria-expanded','false');
                    parentLink.parentElement.setAttribute('aria-expanded','false');
                  }
                }, 120);
              }
            });
        })();
      </script>
    {% endif %}
    <div class="app-shell">
      <main>
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul>
              {% for category, msg in messages %}
                <li><strong>[{{ category }}]</strong> {{ msg }}</li>
              {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}
        {% block content %}{% endblock %}
      </main>
    </div>
    <script>
      (function(){
        // Theme management: auto (system), light, dark
        var root = document.documentElement;
        var metaCS = document.querySelector('meta[name="color-scheme"]');
        function resolvedScheme(mode){
          if (mode === 'dark') return 'dark';
          if (mode === 'light') return 'light';
          try { return (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light'; } catch(_) { return 'light'; }
        }
        function setWaterEnabled(mode){
          // Toggle disabled state on preloaded stylesheets to avoid href swaps and flashing
          return new Promise(function(resolve){
            try {
              var a = document.getElementById('watercss-auto');
              var l = document.getElementById('watercss-light');
              var d = document.getElementById('watercss-dark');
              if (a && l && d){
                a.disabled = !(mode === 'auto');
                l.disabled = !(mode === 'light');
                d.disabled = !(mode === 'dark');
              }
            } catch(_) {}
            // microtask to allow style recalc
            setTimeout(resolve, 0);
          });
        }

        function applyTheme(mode){
          if (mode === 'dark'){
            root.setAttribute('data-theme', 'dark');
            if (metaCS) metaCS.setAttribute('content','dark light');
          } else if (mode === 'light'){
            root.setAttribute('data-theme', 'light');
            if (metaCS) metaCS.setAttribute('content','light dark');
          } else {
            root.removeAttribute('data-theme'); // defer to system
            if (metaCS) metaCS.setAttribute('content','light dark');
          }
          // Hint to UA for form controls & scrollbars
          var scheme = resolvedScheme(mode);
          root.style.colorScheme = scheme;
          root.setAttribute('data-theme-state', scheme + '/' + mode);
          // Enable correct Water.css and after styles settle, notify listeners
          var notify = function(){
            var evt = new CustomEvent('themechange', { detail: { mode: mode, scheme: scheme }, bubbles: true, composed: true });
            window.dispatchEvent(evt);
            document.dispatchEvent(evt);
          };
          // Fire once immediately (fallback), and again after enabling stylesheet
          try { notify(); } catch(_){ }
          setWaterEnabled(mode).then(function(){ notify(); });
          // Force minimal reflow to ensure immediate repaint on some UAs
          try { void document.body.offsetHeight; } catch(_){ }
        }
        try {
          var stored = localStorage.getItem('theme-mode');
          var initial = stored ? stored : 'auto';
          applyTheme(initial);

          // Wire icon buttons
          function updateToggleUI(mode){
            var btns = document.querySelectorAll('.theme-btn');
            btns.forEach(function(b){
              var active = b.getAttribute('data-mode') === mode;
              b.setAttribute('aria-pressed', active ? 'true' : 'false');
              if (active) b.classList.add('active'); else b.classList.remove('active');
            });
          }
          updateToggleUI(initial);
          document.addEventListener('click', function(ev){
            var t = ev.target && ev.target.closest ? ev.target.closest('.theme-btn') : null;
            if (t){
              var val = t.getAttribute('data-mode');
              // In collapsed sidebar, clicking active icon cycles to next mode
              if (document.body.classList.contains('sidebar-collapsed') && t.classList.contains('active')) {
                var order = ['auto','light','dark'];
                var idx = order.indexOf(val);
                val = order[(idx + 1) % order.length];
              }
              if (val === 'auto') localStorage.removeItem('theme-mode');
              else localStorage.setItem('theme-mode', val);
              applyTheme(val);
              updateToggleUI(val);
            }
          });
        } catch(e) { /* no-op */ }
      })();
    </script>
    <script>
      // Delete transaction handler (restored)
      document.addEventListener('click', function(ev) {
        var el = ev.target;
        if (el.classList && el.classList.contains('delete-link')) {
          ev.preventDefault();
          var ask = window.showConfirm ? window.showConfirm({ title: 'Delete transaction', message: 'Delete transaction ' + el.dataset.id + '?' }) : Promise.resolve(confirm('Delete transaction ' + el.dataset.id + '?'));
          ask.then(function(yes){
            if(!yes) return;
            var headers = {'Content-Type': 'application/x-www-form-urlencoded'};
            var meta = document.querySelector('meta[name="csrf-token"]');
            if (meta && meta.content) {
              headers['X-CSRFToken'] = meta.content;
            }
            fetch('/transactions/' + el.dataset.id + '/delete', { method: 'POST', headers: headers, credentials: 'same-origin' })
              .then(function(r){
                if (r.ok) {
                  location.reload();
                } else if (r.status === 403) {
                  alert('Forbidden: you do not have permission to delete this transaction.');
                } else if (r.status === 401) {
                  alert('You appear to be logged out. Please refresh and log in again.');
                  location.reload();
                } else {
                  r.text().then(function(t){ console.error(t); alert('Delete failed'); });
                }
              })
              .catch(function(){ alert('Delete failed'); });
          }).catch(function(){ /* ignore */ });
        }
      });
    </script>
    <!-- Confirmation modal -->
    <div id="confirm-modal" class="confirm-modal" aria-hidden="true" role="dialog" aria-modal="true">
      <div class="confirm-modal-backdrop"></div>
      <div class="confirm-modal-panel" role="document">
        <h3 id="confirm-modal-title"></h3>
        <p id="confirm-modal-message"></p>
        <div class="confirm-modal-controls">
          <button type="button" id="confirm-modal-cancel">Cancel</button>
          <button type="button" id="confirm-modal-ok" class="danger">OK</button>
        </div>
      </div>
    </div>
    <script>
      (function(){
        var modal = document.getElementById('confirm-modal');
        var titleEl = document.getElementById('confirm-modal-title');
        var msgEl = document.getElementById('confirm-modal-message');
        var okBtn = document.getElementById('confirm-modal-ok');
        var cancelBtn = document.getElementById('confirm-modal-cancel');
        function show(opts){
          return new Promise(function(resolve){
            titleEl.textContent = opts.title || 'Confirm';
            msgEl.textContent = opts.message || '';
            modal.setAttribute('aria-hidden','false');
            modal.classList.add('open');
            var cleanup = function(){
              okBtn.removeEventListener('click', onOk);
              cancelBtn.removeEventListener('click', onCancel);
              document.removeEventListener('keydown', onKey);
            };
            function onOk(){ cleanup(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); resolve(true); }
            function onCancel(){ cleanup(); modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); resolve(false); }
            function onKey(e){ if (e.key === 'Escape') onCancel(); }
            okBtn.addEventListener('click', onOk);
            cancelBtn.addEventListener('click', onCancel);
            document.addEventListener('keydown', onKey);
          });
        }
        window.showConfirm = show;
      })();
    </script>
    {% block scripts %}{% endblock %}
    <script>
      // Enhance nav submenu for touch/keyboard users
      (function(){
        var nav = document.querySelector('.nav');
        if (!nav) return;
        // Toggle on click for parent anchors with submenu
        nav.addEventListener('click', function(e){
          var a = e.target.closest('a.parent');
          if (!a) return;
          var item = a.parentElement;
          var submenu = item && item.querySelector('.submenu');
          if (!submenu) return;
          // If clicking the parent and submenu exists, prevent immediate navigation for touch toggle
          // Allow navigation if modifier keys present
          if (!(e.metaKey || e.ctrlKey || e.shiftKey || e.altKey)) {
            e.preventDefault();
          }
          var expanded = a.getAttribute('aria-expanded') === 'true';
          a.setAttribute('aria-expanded', expanded ? 'false' : 'true');
          item.setAttribute('aria-expanded', expanded ? 'false' : 'true');
        });

        // Keyboard support: Enter/Space toggles, Escape closes
        nav.addEventListener('keydown', function(e){
          var a = e.target.closest('a.parent');
          if (a && (e.key === 'Enter' || e.key === ' ')){
            e.preventDefault();
            a.click();
          }
          if (e.key === 'Escape'){
            var open = nav.querySelector('.nav-item[aria-expanded="true"] a.parent');
            if (open){
              open.setAttribute('aria-expanded','false');
              open.parentElement.setAttribute('aria-expanded','false');
              open.focus();
            }
          }
        });

        // Close submenu when clicking outside
        document.addEventListener('click', function(e){
          var inside = e.target.closest('.nav .nav-item');
          if (!inside){
            var opened = nav.querySelectorAll('.nav-item[aria-expanded="true"] a.parent');
            opened.forEach(function(a){
              a.setAttribute('aria-expanded','false');
              if (a.parentElement) a.parentElement.setAttribute('aria-expanded','false');
            });
          }
        });
      })();
    </script>
  </body>
</html>
